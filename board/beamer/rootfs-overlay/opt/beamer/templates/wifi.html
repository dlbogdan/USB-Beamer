<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Beamer Wi‑Fi Setup</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 2rem; }
      .card { max-width: 460px; margin: 0 auto; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; }
      label { display:block; margin-top: 0.75rem; font-weight: 600; }
      input { width:100%; padding:0.6rem; margin-top:0.25rem; box-sizing: border-box; }
      button { margin-top: 1rem; padding: 0.6rem 1rem; }
      .flash { padding: 0.6rem 0.8rem; border-radius: 6px; margin-bottom: 1rem; }
      .flash.error { background: #fee; border: 1px solid #f8bcbc; }
      .flash.success { background: #eef9ee; border: 1px solid #bfe6bf; }
      .row { display:flex; gap: 8px; align-items: center; }
      select { width:100%; padding:0.6rem; margin-top:0.25rem; box-sizing:border-box; }
      small { color:#666; }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Connect Beamer to Wi‑Fi</h2>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      <form method="post" action="{{ url_for('wifi') }}" id="wifiForm">
        <label for="ssid_select">Wi‑Fi networks</label>
        <div class="row">
          <select id="ssid_select">
            <option value="">— Click Scan —</option>
          </select>
          <button type="button" id="scanBtn">Scan</button>
        </div>
        <small>Select a network or enter manually for a hidden SSID.</small>

        <label for="ssid">SSID (manual)</label>
        <input id="ssid" name="ssid" placeholder="Network name" required>

        <label for="password">Password</label>
        <input id="password" name="password" type="password" placeholder="Password" required>

        <button type="submit">Connect</button>
      </form>
    </div>
    <script>
      const scanBtn = document.getElementById('scanBtn');
      const selectEl = document.getElementById('ssid_select');
      const ssidInput = document.getElementById('ssid');
      scanBtn.addEventListener('click', async () => {
        scanBtn.disabled = true;
        scanBtn.textContent = 'Scanning…';
        try {
          const resp = await fetch('{{ url_for('api_wifi_scan') }}');
          const data = await resp.json();
          selectEl.innerHTML = '';
          if (!data.ok) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = data.error || 'Scan failed';
            selectEl.appendChild(opt);
          } else {
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = `Found ${data.networks.length} network(s)`;
            selectEl.appendChild(placeholder);
            for (const n of data.networks) {
              if (!n.ssid) continue;
              const opt = document.createElement('option');
              opt.value = n.ssid;
              const sig = (n.signal !== null && n.signal !== undefined) ? ` (${Math.round(n.signal)} dBm)` : '';
              opt.textContent = n.ssid + sig;
              selectEl.appendChild(opt);
            }
          }
        } catch (e) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'Scan error';
          selectEl.appendChild(opt);
        } finally {
          scanBtn.disabled = false;
          scanBtn.textContent = 'Scan';
        }
      });
      selectEl.addEventListener('change', () => {
        if (selectEl.value) ssidInput.value = selectEl.value;
      });
    </script>
  </body>
  </html>


