#!/bin/sh
#
# Convert netplan configuration to interfaces format on every boot
#

NETPLAN_CONFIG="/boot/network-config"
CONVERTER_SCRIPT="/usr/scripts/netplan_converter.py"

# Source function library if it exists
[ -r /etc/init.d/functions ] && . /etc/init.d/functions

start() {
    printf "Converting network configuration: "

    # Check if converter script exists
    if [ ! -f "$CONVERTER_SCRIPT" ]; then
        echo "FAIL (converter not found)"
        return 1
    fi

    # Check if network config exists
    if [ ! -f "$NETPLAN_CONFIG" ]; then
        echo "SKIP (no config)"
        return 0
    fi

    # Always convert from /boot/network-config so that this file is the
    # single source of truth for networking on each boot.
    if python3 "$CONVERTER_SCRIPT" "$NETPLAN_CONFIG" 2>/dev/null; then
        echo "OK"
    else
        echo "FAIL"
        return 1
    fi

    return 0
}

stop() {
    # Nothing to do
    return 0
}

restart() {
    stop
    start
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        restart
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit $?
