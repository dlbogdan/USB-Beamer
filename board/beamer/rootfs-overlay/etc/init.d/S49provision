#!/bin/sh

### BEGIN INIT INFO
# Provides:          beamer-provision
# Required-Start:    $local_fs $network
# Required-Stop:     $local_fs $network
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Bring up provisioning SoftAP when not provisioned
### END INIT INFO

APP_DIR=/opt/beamer
APP_BIN="/usr/bin/python3 $APP_DIR/provision_app.py"
APP_PORT=80
DNSMASQ_PID=/var/run/dnsmasq-provision.pid
HOSTAPD_CONF_RUNTIME=/run/hostapd-provision.conf

start() {
    # If wlan0 already has an IPv4 address, assume Wi‑Fi is up and skip AP.
    # This covers both cases where /boot/network-config was provided manually
    # and where it was generated by the portal.
    echo "Checking existing Wi‑Fi connection on wlan0..."
    WAIT_SECS=20
    while [ "$WAIT_SECS" -gt 0 ]; do
        if ip -4 -o addr show dev wlan0 2>/dev/null | grep -q inet; then
            echo "wlan0 already has IPv4; skipping provisioning AP"
            return 0
        fi
        sleep 2
        WAIT_SECS=$((WAIT_SECS - 2))
    done

    echo "Starting provisioning AP..."
    ip link set wlan0 up 2>/dev/null
    ip addr flush dev wlan0
    ip addr add 192.168.4.1/24 dev wlan0

    # Prepare runtime hostapd config using the current hostname as SSID
    mkdir -p "$(dirname "$HOSTAPD_CONF_RUNTIME")"
    SSID_NAME=$(hostname 2>/dev/null || echo "beamer")
    cat >"$HOSTAPD_CONF_RUNTIME" <<EOF
interface=wlan0
driver=nl80211
ssid=$SSID_NAME
hw_mode=g
channel=6
wmm_enabled=1
ignore_broadcast_ssid=0
EOF

    # Start dnsmasq and hostapd
    dnsmasq --conf-file=/etc/dnsmasq.conf --pid-file=$DNSMASQ_PID
    hostapd -B "$HOSTAPD_CONF_RUNTIME"

    # Start Flask app on port 80 if not already running
    if ! pgrep -f "$APP_BIN" >/dev/null 2>&1; then
        echo "Starting portal app on port $APP_PORT..."
        APP_PORT=$APP_PORT $APP_BIN &
    fi
}

stop() {
    echo "Stopping provisioning AP..."
    killall hostapd 2>/dev/null
    if [ -f "$DNSMASQ_PID" ]; then
        kill "$(cat $DNSMASQ_PID)" 2>/dev/null
        rm -f "$DNSMASQ_PID"
    else
        killall dnsmasq 2>/dev/null
    fi
}

case "$1" in
  start)
    start
    ;;
  stop)
    stop
    ;;
  restart)
    stop
    start
    ;;
  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
    ;;
esac

exit 0


