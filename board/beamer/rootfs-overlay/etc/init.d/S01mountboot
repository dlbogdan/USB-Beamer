#!/bin/sh
#
# Mount boot partition dynamically
#

BOOT_MOUNT="/boot"
LOG_TAG="S01mountboot"

# Common Beamer init helpers
[ -r /etc/init.d/common-func ] && . /etc/init.d/common-func

start() {
    printf "Mounting boot partition: "
    log_info "Mounting boot partition"
    
    # Get the root device from /proc/cmdline or /proc/mounts
    ROOT_DEV=$(grep -o 'root=[^ ]*' /proc/cmdline | cut -d= -f2)
    
    # If root is /dev/mmcblk0p2, boot is likely /dev/mmcblk0p1
    # making this generic so it will work with newer raspberries or even PCs
    if echo "$ROOT_DEV" | grep -q "mmcblk"; then
        BOOT_DEV=$(echo $ROOT_DEV | sed 's/p[0-9]*$/p1/')
    elif echo "$ROOT_DEV" | grep -q "sd"; then
        BOOT_DEV=$(echo $ROOT_DEV | sed 's/[0-9]*$/1/')
    elif echo "$ROOT_DEV" | grep -q "nvme"; then
        BOOT_DEV=$(echo $ROOT_DEV | sed 's/p[0-9]*$/p1/')
    else
        log_err "FAIL (unknown root device: $ROOT_DEV)"
        return 1
    fi
    
    # Create mount point if it doesn't exist
    mkdir -p $BOOT_MOUNT
    
    # Check if device exists
    if [ ! -b "$BOOT_DEV" ]; then
        log_err "FAIL ($BOOT_DEV not found)"
        return 1
    fi
    
    # Mount the boot partition
    if mount $BOOT_DEV $BOOT_MOUNT 2>/dev/null; then
        log_info "OK ($BOOT_DEV) - mounted on $BOOT_MOUNT"
        return 0
    else
        log_err "FAIL (mount error for $BOOT_DEV on $BOOT_MOUNT)"
        return 1
    fi
}

stop() {
    printf "Unmounting boot partition: "
    if umount $BOOT_MOUNT 2>/dev/null; then
        log_info "OK - unmounted $BOOT_MOUNT"
        return 0
    else
        log_err "FAIL - could not unmount $BOOT_MOUNT"
        return 1
    fi
}

restart() {
    stop
    start
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart|reload)
        restart
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit $?

